Imports System
Imports System.Collections.Generic
Imports OfficeOpenXml

Module Program
    Sub Main()
        Dim filePath As String = "output.xlsx" ' Change the file path as needed

        Using package As New ExcelPackage()
            Dim worksheet As ExcelWorksheet = package.Workbook.Worksheets.Add("Data")

            ' Your deeply nested object (replace this with your data)
            Dim deeplyNestedObject = New With {
                .name = "John",
                .age = 30,
                .address = New With {
                    .street = "123 Main St",
                    .city = "Exampleville",
                    .country = New With {
                        .name = "United States",
                        .code = "US",
                        .state = New With {
                            .name = "New York",
                            .code = "NY",
                            .region = New With {
                                .name = "Northeast",
                                .code = "NE",
                                .moreData = New With {
                                    .key1 = "Value1",
                                    .key2 = "Value2"
                                }
                            }
                        }
                    }
                },
                .hobbies = {"Reading", "Hiking"}
            }

            Dim startColumn As Integer = 1
            Dim startRow As Integer = 1

            WriteObjectToExcel(worksheet, deeplyNestedObject, startRow, startColumn)

            ' Save the Excel file
            package.SaveAs(New System.IO.FileInfo(filePath))
        End Using

        Console.WriteLine("Excel file saved.")
    End Sub

    Sub WriteObjectToExcel(worksheet As ExcelWorksheet, obj As Object, ByRef row As Integer, ByRef col As Integer, Optional parentKey As String = "")
        If TypeOf obj Is IDictionary(Of String, Object) Then
            For Each kvp In DirectCast(obj, IDictionary(Of String, Object))
                Dim key = kvp.Key
                Dim value = kvp.Value

                worksheet.Cells(row, col).Value = key
                worksheet.Cells(row + 1, col).Value = value.ToString()

                ' Check if the value is a nested object
                If TypeOf value Is IDictionary(Of String, Object) Then
                    col += 1
                    worksheet.Cells(row + 2, col).Value = "Nested Properties"
                    col += 1
                    WriteObjectToExcel(worksheet, DirectCast(value, IDictionary(Of String, Object)), row, col, key)
                End If

                col += 1
            Next
        ElseIf TypeOf obj Is IEnumerable(Of Object) Then
            ' Handle lists if needed
        Else
            worksheet.Cells(row, col).Value = parentKey
            worksheet.Cells(row + 1, col).Value = obj.ToString()
            col += 1
        End If
    End Sub
End Module
